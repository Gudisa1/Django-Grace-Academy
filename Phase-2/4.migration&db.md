# **Django Migrations, Database Setup, and Shell Tutorial**

## **Objective**
By the end of this tutorial, you'll understand Django's migration system, how to set up databases, and how to interact with your database using the Django shell to create and retrieve records.

---

## **Prerequisites**
- Django project already created (`django-admin startproject myproject`)
- At least one Django app created (`python manage.py startapp myapp`)
- Basic understanding of Django models

---

## **Part 1: Migrations & Database Setup**

### **Step 1: Understanding Django Migrations**

**What are migrations?**
- Migrations are Django's way of propagating changes you make to your models (adding a field, deleting a model, etc.) into your database schema
- They're version control for your database schema

**The migration flow:**
```
Model changes → makemigrations → migrate → Updated database
```

### **Step 2: Create a Simple Model**

First, let's create a model to work with. Open `myapp/models.py`:

```python
from django.db import models

class Book(models.Model):
    title = models.CharField(max_length=200)
    author = models.CharField(max_length=100)
    published_date = models.DateField()
    price = models.DecimalField(max_digits=6, decimal_places=2)
    in_stock = models.BooleanField(default=True)
    
    def __str__(self):
        return f"{self.title} by {self.author}"
```

### **Step 3: Register Your App**

Make sure your app is registered in `settings.py`:

```python
# In myproject/settings.py
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',  # Add your app here
]
```

### **Step 4: Create Migrations with `makemigrations`**

Run this command to create migration files:

```bash
python manage.py makemigrations
```

**What happens:**
1. Django detects changes in your models
2. Creates a migration file in `myapp/migrations/0001_initial.py`
3. This file contains instructions for creating the database table

**Check the migration file:**
```bash
# View SQL that will be executed
python manage.py sqlmigrate myapp 0001
```

### **Step 5: Apply Migrations with `migrate`**

Apply the migrations to your database:

```bash
python manage.py migrate
```

**What happens:**
1. Django creates the database file (`db.sqlite3` by default)
2. Applies all pending migrations
3. Creates necessary tables including Django's built-in tables

**Check what was applied:**
```bash
# See migration status
python manage.py showmigrations
```

### **Step 6: View SQLite Database**

**Option A: Using Command Line**
```bash
# Install SQLite3 if not present
# On Ubuntu: sudo apt-get install sqlite3
# On Mac: brew install sqlite3

# Open your database
sqlite3 db.sqlite3

# Inside SQLite shell:
.tables  # Show all tables
.schema myapp_book  # Show table structure
SELECT * FROM myapp_book;  # View data
.quit  # Exit
```

**Option B: Using DB Browser for SQLite (GUI)**
1. Download from [sqlitebrowser.org](https://sqlitebrowser.org/)
2. Open `db.sqlite3`
3. Browse tables, data, and run SQL queries

**Option C: Django Extensions**
```bash
pip install django-extensions
# Add to INSTALLED_APPS
python manage.py shell_plus --print-sql
```

---

## **Part 2: Django Shell & Sample Records**

### **Step 7: Enter Django Shell**

```bash
python manage.py shell
```

You'll see the Python interactive shell with Django's settings loaded.

### **Step 8: Import Your Model**

```python
# In the Django shell
from myapp.models import Book
from django.utils import timezone
import datetime
```

### **Step 9: Create Records**

**Method 1: Using `create()`**
```python
# Create a single record
book1 = Book.objects.create(
    title="The Great Gatsby",
    author="F. Scott Fitzgerald",
    published_date=datetime.date(1925, 4, 10),
    price=12.99,
    in_stock=True
)
```

**Method 2: Create and save separately**
```python
book2 = Book(
    title="To Kill a Mockingbird",
    author="Harper Lee",
    published_date=datetime.date(1960, 7, 11),
    price=14.50,
    in_stock=True
)
book2.save()  # Save to database
```

**Method 3: Bulk create (efficient for many records)**
```python
books = [
    Book(title="1984", author="George Orwell", 
         published_date=datetime.date(1949, 6, 8), price=10.99),
    Book(title="Pride and Prejudice", author="Jane Austen",
         published_date=datetime.date(1813, 1, 28), price=9.99),
    Book(title="The Hobbit", author="J.R.R. Tolkien",
         published_date=datetime.date(1937, 9, 21), price=15.99),
]
Book.objects.bulk_create(books)
```

### **Step 10: Retrieve Records**

**Get all records:**
```python
all_books = Book.objects.all()
for book in all_books:
    print(f"{book.id}: {book.title} - ${book.price}")
```

**Get single record by ID:**
```python
book = Book.objects.get(id=1)
print(book.title, book.author)
```

**Filter records:**
```python
# Books in stock
in_stock_books = Book.objects.filter(in_stock=True)

# Books by specific author
orwell_books = Book.objects.filter(author="George Orwell")

# Books cheaper than $15
cheap_books = Book.objects.filter(price__lt=15)  # __lt means "less than"

# Books published after 1950
recent_books = Book.objects.filter(published_date__year__gt=1950)
```

**Complex queries:**
```python
# AND condition (using multiple filters)
books = Book.objects.filter(in_stock=True).filter(price__lt=20)

# OR condition (using Q objects)
from django.db.models import Q
books = Book.objects.filter(
    Q(author="George Orwell") | Q(author="J.R.R. Tolkien")
)

# Ordering
books = Book.objects.all().order_by('title')  # Ascending
books = Book.objects.all().order_by('-price')  # Descending

# Limiting results
first_three = Book.objects.all()[:3]
```

### **Step 11: Update Records**

```python
# Get and update
book = Book.objects.get(id=1)
book.price = 11.99
book.save()

# Bulk update
Book.objects.filter(author="George Orwell").update(price=8.99)
```

### **Step 12: Delete Records**

```python
# Delete single record
book = Book.objects.get(id=5)
book.delete()

# Delete multiple records
Book.objects.filter(author="Jane Austen").delete()
```

### **Step 13: Count and Aggregate**

```python
# Count records
total_books = Book.objects.count()
in_stock_count = Book.objects.filter(in_stock=True).count()

# Aggregate functions
from django.db.models import Avg, Max, Min, Sum
average_price = Book.objects.aggregate(Avg('price'))
max_price = Book.objects.aggregate(Max('price'))
```

---

## **Common Pitfalls & Tips**

### **Pitfall 1: Forgetting to run migrations**
**Solution:** Always run both commands:
```bash
python manage.py makemigrations
python manage.py migrate
```

### **Pitfall 2: Editing migration files manually**
**Solution:** Don't edit migration files directly. Use `makemigrations` again.

### **Pitfall 3: Using `get()` when multiple objects exist**
```python
# Wrong - will crash if multiple books by same author
book = Book.objects.get(author="George Orwell")

# Better
books = Book.objects.filter(author="George Orwell")
first_book = books.first()
```

### **Pitfall 4: Not handling DoesNotExist exception**
```python
# Wrong - will crash if book doesn't exist
book = Book.objects.get(id=999)

# Correct
try:
    book = Book.objects.get(id=999)
except Book.DoesNotExist:
    print("Book not found")
```

### **Helpful Tips:**
1. **View raw SQL:** Add `print(Book.objects.all().query)` to see SQL
2. **Use `shell_plus`:** From django-extensions for better shell experience
3. **Reset database:** To start fresh:
   ```bash
   rm db.sqlite3
   python manage.py migrate
   ```
4. **Migration rollback:** `python manage.py migrate myapp 0001` (specific migration)

---

## **Next Steps & Practice Exercises**

### **Exercise 1: Add a New Field**
1. Add `page_count = models.IntegerField(default=0)` to your Book model
2. Run `makemigrations` and `migrate`
3. Update some records in the shell with page counts

### **Exercise 2: Create Related Models**
```python
# Add to models.py
class Author(models.Model):
    name = models.CharField(max_length=100)
    nationality = models.CharField(max_length=50)
    
class Book(models.Model):
    # Change author field to:
    author = models.ForeignKey(Author, on_delete=models.CASCADE)
    # ... rest of fields
```

### **Exercise 3: Advanced Queries**
Practice these queries in the shell:
1. Find all books published in the 20th century
2. Calculate total value of all books in stock
3. Find authors with more than 1 book in your database

### **Useful Resources:**
- [Django Database Documentation](https://docs.djangoproject.com/en/stable/topics/db/)
- [Django Shell Documentation](https://docs.djangoproject.com/en/stable/ref/django-admin/#shell)
- [SQLite Tutorial](https://www.sqlitetutorial.net/)

---

## **Quick Reference Commands**

```bash
# Migration commands
python manage.py makemigrations
python manage.py migrate
python manage.py showmigrations
python manage.py sqlmigrate app_name migration_number

# Shell commands
python manage.py shell
python manage.py shell_plus  # with django-extensions

# Database
sqlite3 db.sqlite3  # Open SQLite shell
```

