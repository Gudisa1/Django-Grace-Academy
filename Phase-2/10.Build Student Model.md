# **Complete Student Management System with Advanced Features**

## **Project Structure**
```bash
student_management_system/
├── manage.py
├── requirements.txt
├── .env
├── .gitignore
├── README.md
├── sms/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   ├── wsgi.py
│   └── asgi.py
├── students/
│   ├── migrations/
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── forms.py
│   ├── models.py
│   ├── tests.py
│   ├── urls.py
│   ├── views.py
│   └── templatetags/
│       └── __init__.py
├── templates/
│   ├── base.html
│   ├── students/
│   │   ├── home.html
│   │   ├── dashboard.html
│   │   ├── student_list.html
│   │   ├── student_detail.html
│   │   ├── student_form.html
│   │   ├── confirm_delete.html
│   │   ├── search_results.html
│   │   └── reports/
│   │       ├── report_list.html
│   │       └── report_detail.html
│   └── includes/
│       ├── navbar.html
│       ├── footer.html
│       ├── messages.html
│       └── pagination.html
├── static/
│   ├── css/
│   │   └── style.css
│   ├── js/
│   │   └── main.js
│   └── images/
├── media/
│   └── student_photos/
└── fixtures/
    └── initial_data.json
```

---

## **Part 1: Advanced Models**

### **models.py**
```python
# students/models.py
from django.db import models
from django.contrib.auth.models import User
from django.core.validators import MinValueValidator, MaxValueValidator
from django.utils import timezone
import uuid
import os

def student_photo_path(instance, filename):
    """Generate path for student photos"""
    ext = filename.split('.')[-1]
    filename = f"{uuid.uuid4()}.{ext}"
    return os.path.join('student_photos', filename)

class Department(models.Model):
    """Department/Course model"""
    code = models.CharField(max_length=10, unique=True)
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    established_date = models.DateField(default=timezone.now)
    hod = models.CharField(max_length=100, blank=True)
    email = models.EmailField(blank=True)
    phone = models.CharField(max_length=15, blank=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        ordering = ['name']
        verbose_name = "Department"
        verbose_name_plural = "Departments"
    
    def __str__(self):
        return f"{self.code} - {self.name}"
    
    def student_count(self):
        return self.student_set.count()

class Student(models.Model):
    """Main Student model"""
    
    GENDER_CHOICES = [
        ('M', 'Male'),
        ('F', 'Female'),
        ('O', 'Other'),
    ]
    
    BLOOD_GROUP_CHOICES = [
        ('A+', 'A+'), ('A-', 'A-'),
        ('B+', 'B+'), ('B-', 'B-'),
        ('O+', 'O+'), ('O-', 'O-'),
        ('AB+', 'AB+'), ('AB-', 'AB-'),
    ]
    
    # Basic Information
    student_id = models.CharField(max_length=20, unique=True, editable=False)
    first_name = models.CharField(max_length=100)
    last_name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    phone = models.CharField(max_length=15)
    alternate_phone = models.CharField(max_length=15, blank=True)
    
    # Personal Details
    date_of_birth = models.DateField()
    gender = models.CharField(max_length=1, choices=GENDER_CHOICES)
    blood_group = models.CharField(max_length=3, choices=BLOOD_GROUP_CHOICES, blank=True)
    nationality = models.CharField(max_length=50, default='Indian')
    aadhar_number = models.CharField(max_length=12, unique=True, blank=True, null=True)
    
    # Address
    address_line1 = models.CharField(max_length=200)
    address_line2 = models.CharField(max_length=200, blank=True)
    city = models.CharField(max_length=100)
    state = models.CharField(max_length=100)
    pincode = models.CharField(max_length=10)
    country = models.CharField(max_length=100, default='India')
    
    # Academic Information
    department = models.ForeignKey(Department, on_delete=models.PROTECT)
    enrollment_date = models.DateField(default=timezone.now)
    graduation_date = models.DateField(blank=True, null=True)
    current_semester = models.IntegerField(
        default=1,
        validators=[MinValueValidator(1), MaxValueValidator(8)]
    )
    roll_number = models.CharField(max_length=20, unique=True)
    
    # Academic Performance
    cgpa = models.DecimalField(
        max_digits=4,
        decimal_places=2,
        default=0.00,
        validators=[MinValueValidator(0.00), MaxValueValidator(10.00)]
    )
    attendance_percentage = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        default=0.00,
        validators=[MinValueValidator(0.00), MaxValueValidator(100.00)]
    )
    
    # Additional Details
    guardian_name = models.CharField(max_length=100)
    guardian_phone = models.CharField(max_length=15)
    guardian_relationship = models.CharField(max_length=50)
    emergency_contact = models.CharField(max_length=15)
    
    # Documents & Media
    photo = models.ImageField(upload_to=student_photo_path, blank=True, null=True)
    signature = models.ImageField(upload_to='student_signatures/', blank=True, null=True)
    
    # Status & Audit
    is_active = models.BooleanField(default=True)
    is_hosteller = models.BooleanField(default=False)
    hostel_room = models.CharField(max_length=20, blank=True)
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name='created_students')
    updated_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name='updated_students')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-enrollment_date', 'roll_number']
        indexes = [
            models.Index(fields=['student_id']),
            models.Index(fields=['roll_number']),
            models.Index(fields=['email']),
            models.Index(fields=['department']),
        ]
        verbose_name = "Student"
        verbose_name_plural = "Students"
    
    def __str__(self):
        return f"{self.student_id} - {self.get_full_name()}"
    
    def get_full_name(self):
        return f"{self.first_name} {self.last_name}"
    
    def save(self, *args, **kwargs):
        """Generate student ID if not exists"""
        if not self.student_id:
            year = self.enrollment_date.year
            dept_code = self.department.code
            last_student = Student.objects.filter(
                enrollment_date__year=year,
                department=self.department
            ).count()
            self.student_id = f"{year}{dept_code}{last_student + 1:04d}"
        super().save(*args, **kwargs)
    
    def get_age(self):
        """Calculate age from date of birth"""
        today = timezone.now().date()
        return today.year - self.date_of_birth.year - (
            (today.month, today.day) < (self.date_of_birth.month, self.date_of_birth.day)
        )
    
    def academic_status(self):
        """Get academic status based on CGPA"""
        if self.cgpa >= 8.0:
            return "Excellent"
        elif self.cgpa >= 6.5:
            return "Good"
        elif self.cgpa >= 5.0:
            return "Average"
        else:
            return "Needs Improvement"
    
    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('student_detail', kwargs={'pk': self.pk})

class AcademicRecord(models.Model):
    """Store semester-wise academic records"""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='academic_records')
    semester = models.IntegerField(validators=[MinValueValidator(1), MaxValueValidator(8)])
    sgpa = models.DecimalField(max_digits=4, decimal_places=2)
    credits_earned = models.IntegerField()
    credits_total = models.IntegerField()
    result = models.CharField(max_length=20, choices=[
        ('PASS', 'Pass'),
        ('FAIL', 'Fail'),
        ('ATKT', 'ATKT'),
    ])
    year = models.IntegerField()
    
    class Meta:
        unique_together = ['student', 'semester']
        ordering = ['student', '-semester']
    
    def __str__(self):
        return f"{self.student} - Semester {self.semester}"

class Attendance(models.Model):
    """Student attendance records"""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='attendances')
    date = models.DateField()
    subject = models.CharField(max_length=100)
    status = models.CharField(max_length=10, choices=[
        ('PRESENT', 'Present'),
        ('ABSENT', 'Absent'),
        ('LEAVE', 'Leave'),
    ])
    remarks = models.TextField(blank=True)
    
    class Meta:
        unique_together = ['student', 'date', 'subject']
        ordering = ['-date', 'student']
    
    def __str__(self):
        return f"{self.student} - {self.date} - {self.subject}"

class FeePayment(models.Model):
    """Fee payment records"""
    PAYMENT_METHOD_CHOICES = [
        ('CASH', 'Cash'),
        ('CHEQUE', 'Cheque'),
        ('ONLINE', 'Online'),
        ('CARD', 'Card'),
    ]
    
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='fee_payments')
    payment_id = models.CharField(max_length=50, unique=True)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    payment_date = models.DateField(default=timezone.now)
    payment_method = models.CharField(max_length=20, choices=PAYMENT_METHOD_CHOICES)
    semester = models.IntegerField()
    academic_year = models.CharField(max_length=9)  # Format: 2023-2024
    transaction_id = models.CharField(max_length=100, blank=True)
    receipt_number = models.CharField(max_length=50, unique=True)
    is_verified = models.BooleanField(default=False)
    verified_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True)
    remarks = models.TextField(blank=True)
    
    class Meta:
        ordering = ['-payment_date']
    
    def __str__(self):
        return f"{self.student} - {self.receipt_number} - ₹{self.amount}"

class Document(models.Model):
    """Student documents"""
    DOCUMENT_TYPES = [
        ('ADMISSION', 'Admission Form'),
        ('MARKSHEET', 'Marksheet'),
        ('LC', 'Leaving Certificate'),
        ('TC', 'Transfer Certificate'),
        ('AADHAR', 'Aadhar Card'),
        ('PAN', 'PAN Card'),
        ('PHOTO', 'Photograph'),
        ('OTHER', 'Other'),
    ]
    
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='documents')
    document_type = models.CharField(max_length=50, choices=DOCUMENT_TYPES)
    title = models.CharField(max_length=200)
    file = models.FileField(upload_to='student_documents/')
    upload_date = models.DateTimeField(auto_now_add=True)
    uploaded_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    is_verified = models.BooleanField(default=False)
    remarks = models.TextField(blank=True)
    
    class Meta:
        ordering = ['-upload_date']
    
    def __str__(self):
        return f"{self.student} - {self.title}"

class Notification(models.Model):
    """System notifications"""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='notifications')
    title = models.CharField(max_length=200)
    message = models.TextField()
    notification_type = models.CharField(max_length=20, choices=[
        ('INFO', 'Information'),
        ('WARNING', 'Warning'),
        ('ALERT', 'Alert'),
        ('REMINDER', 'Reminder'),
    ])
    is_read = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    
    class Meta:
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.student} - {self.title}"
```

---

## **Part 2: Advanced Forms**

### **forms.py**
```python
# students/forms.py
from django import forms
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from django.utils import timezone
from .models import (
    Student, Department, AcademicRecord,
    Attendance, FeePayment, Document
)
import re
from datetime import date

class DepartmentForm(forms.ModelForm):
    class Meta:
        model = Department
        fields = '__all__'
        widgets = {
            'established_date': forms.DateInput(attrs={'type': 'date'}),
            'description': forms.Textarea(attrs={'rows': 3}),
        }
    
    def clean_code(self):
        code = self.cleaned_data['code']
        if not re.match(r'^[A-Z]{2,5}$', code):
            raise ValidationError("Department code must be 2-5 uppercase letters")
        return code

class StudentForm(forms.ModelForm):
    confirm_email = forms.EmailField(label="Confirm Email")
    confirm_phone = forms.CharField(label="Confirm Phone", max_length=15)
    photo = forms.ImageField(required=False, widget=forms.FileInput)
    
    class Meta:
        model = Student
        exclude = ['student_id', 'created_by', 'updated_by', 'created_at', 'updated_at']
        widgets = {
            'date_of_birth': forms.DateInput(attrs={'type': 'date', 'max': '2006-12-31'}),
            'enrollment_date': forms.DateInput(attrs={'type': 'date'}),
            'graduation_date': forms.DateInput(attrs={'type': 'date'}),
            'address_line1': forms.Textarea(attrs={'rows': 2}),
            'address_line2': forms.Textarea(attrs={'rows': 2}),
            'remarks': forms.Textarea(attrs={'rows': 3}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Set date max for DOB (minimum 16 years)
        min_date = date.today().replace(year=date.today().year - 16)
        self.fields['date_of_birth'].widget.attrs['max'] = min_date.isoformat()
        
        # Add Bootstrap classes
        for field_name, field in self.fields.items():
            if field_name not in ['is_active', 'is_hosteller', 'photo', 'signature']:
                field.widget.attrs['class'] = 'form-control'
            elif field_name in ['is_active', 'is_hosteller']:
                field.widget.attrs['class'] = 'form-check-input'
    
    def clean_date_of_birth(self):
        dob = self.cleaned_data.get('date_of_birth')
        if dob:
            age = date.today().year - dob.year - (
                (date.today().month, date.today().day) < (dob.month, dob.day)
            )
            if age < 16:
                raise ValidationError("Student must be at least 16 years old")
            if age > 100:
                raise ValidationError("Please enter a valid date of birth")
        return dob
    
    def clean_aadhar_number(self):
        aadhar = self.cleaned_data.get('aadhar_number')
        if aadhar:
            if not re.match(r'^\d{12}$', aadhar):
                raise ValidationError("Aadhar number must be 12 digits")
            if Student.objects.filter(aadhar_number=aadhar).exclude(pk=self.instance.pk).exists():
                raise ValidationError("Aadhar number already registered")
        return aadhar
    
    def clean_email(self):
        email = self.cleaned_data.get('email')
        if Student.objects.filter(email=email).exclude(pk=self.instance.pk).exists():
            raise ValidationError("Email already registered")
        return email.lower()
    
    def clean_phone(self):
        phone = self.cleaned_data.get('phone')
        if phone:
            phone = re.sub(r'\D', '', phone)
            if len(phone) != 10:
                raise ValidationError("Phone number must be 10 digits")
        return phone
    
    def clean(self):
        cleaned_data = super().clean()
        
        # Email confirmation
        email = cleaned_data.get('email')
        confirm_email = cleaned_data.get('confirm_email')
        if email and confirm_email and email != confirm_email:
            self.add_error('confirm_email', "Emails do not match")
        
        # Phone confirmation
        phone = cleaned_data.get('phone')
        confirm_phone = cleaned_data.get('confirm_phone')
        if phone and confirm_phone and phone != confirm_phone:
            self.add_error('confirm_phone', "Phone numbers do not match")
        
        # Enrollment date validation
        enrollment_date = cleaned_data.get('enrollment_date')
        if enrollment_date and enrollment_date > date.today():
            self.add_error('enrollment_date', "Enrollment date cannot be in future")
        
        # Graduation date validation
        graduation_date = cleaned_data.get('graduation_date')
        if enrollment_date and graduation_date:
            if graduation_date < enrollment_date:
                self.add_error('graduation_date', "Graduation date must be after enrollment date")
        
        return cleaned_data

class StudentSearchForm(forms.Form):
    SEARCH_CHOICES = [
        ('student_id', 'Student ID'),
        ('name', 'Name'),
        ('email', 'Email'),
        ('roll_number', 'Roll Number'),
        ('department', 'Department'),
        ('phone', 'Phone'),
    ]
    
    search_by = forms.ChoiceField(choices=SEARCH_CHOICES, initial='name')
    search_query = forms.CharField(required=False, max_length=100)
    department = forms.ModelChoiceField(
        queryset=Department.objects.filter(is_active=True),
        required=False,
        empty_label="All Departments"
    )
    is_active = forms.ChoiceField(
        choices=[('', 'All'), ('active', 'Active Only'), ('inactive', 'Inactive Only')],
        required=False
    )
    enrollment_year = forms.IntegerField(
        required=False,
        min_value=2000,
        max_value=date.today().year,
        widget=forms.NumberInput(attrs={'placeholder': 'e.g., 2023'})
    )
    
    def clean_search_query(self):
        query = self.cleaned_data.get('search_query')
        if query:
            # Remove extra spaces
            query = ' '.join(query.split())
        return query

class AcademicRecordForm(forms.ModelForm):
    class Meta:
        model = AcademicRecord
        fields = '__all__'
        widgets = {
            'result': forms.Select(attrs={'class': 'form-select'}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field_name, field in self.fields.items():
            field.widget.attrs['class'] = 'form-control'
    
    def clean_sgpa(self):
        sgpa = self.cleaned_data.get('sgpa')
        if sgpa is not None:
            if sgpa < 0 or sgpa > 10:
                raise ValidationError("SGPA must be between 0 and 10")
        return sgpa

class AttendanceForm(forms.ModelForm):
    class Meta:
        model = Attendance
        fields = '__all__'
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date'}),
            'status': forms.Select(attrs={'class': 'form-select'}),
            'remarks': forms.Textarea(attrs={'rows': 2}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field_name, field in self.fields.items():
            if field_name != 'status':
                field.widget.attrs['class'] = 'form-control'
    
    def clean_date(self):
        date_value = self.cleaned_data.get('date')
        if date_value and date_value > date.today():
            raise ValidationError("Attendance date cannot be in future")
        return date_value

class FeePaymentForm(forms.ModelForm):
    class Meta:
        model = FeePayment
        fields = '__all__'
        exclude = ['payment_id', 'is_verified', 'verified_by']
        widgets = {
            'payment_date': forms.DateInput(attrs={'type': 'date'}),
            'payment_method': forms.Select(attrs={'class': 'form-select'}),
            'remarks': forms.Textarea(attrs={'rows': 2}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field_name, field in self.fields.items():
            if field_name != 'payment_method':
                field.widget.attrs['class'] = 'form-control'
    
    def clean_amount(self):
        amount = self.cleaned_data.get('amount')
        if amount and amount <= 0:
            raise ValidationError("Amount must be greater than 0")
        return amount

class DocumentForm(forms.ModelForm):
    class Meta:
        model = Document
        fields = '__all__'
        exclude = ['upload_date', 'uploaded_by']
        widgets = {
            'document_type': forms.Select(attrs={'class': 'form-select'}),
            'remarks': forms.Textarea(attrs={'rows': 2}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field_name, field in self.fields.items():
            if field_name != 'document_type':
                field.widget.attrs['class'] = 'form-control'
    
    def clean_file(self):
        file = self.cleaned_data.get('file')
        if file:
            # Check file size (5MB limit)
            max_size = 5 * 1024 * 1024  # 5MB
            if file.size > max_size:
                raise ValidationError("File size must be less than 5MB")
            
            # Check file extension
            allowed_extensions = ['.pdf', '.jpg', '.jpeg', '.png', '.doc', '.docx']
            if not any(file.name.lower().endswith(ext) for ext in allowed_extensions):
                raise ValidationError("Unsupported file type. Allowed: PDF, JPG, PNG, DOC")
        
        return file

class BulkUploadForm(forms.Form):
    file = forms.FileField(label="CSV/Excel File")
    upload_type = forms.ChoiceField(
        choices=[
            ('students', 'Students'),
            ('attendance', 'Attendance'),
            ('fees', 'Fee Payments'),
        ],
        widget=forms.Select(attrs={'class': 'form-select'})
    )

class ReportFilterForm(forms.Form):
    REPORT_TYPES = [
        ('department_wise', 'Department Wise Report'),
        ('attendance_summary', 'Attendance Summary'),
        ('fee_collection', 'Fee Collection Report'),
        ('academic_performance', 'Academic Performance'),
        ('student_demographics', 'Student Demographics'),
    ]
    
    report_type = forms.ChoiceField(choices=REPORT_TYPES, widget=forms.Select(attrs={'class': 'form-select'}))
    start_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=False)
    end_date = forms.DateField(widget=forms.DateInput(attrs={'type': 'date'}), required=False)
    department = forms.ModelChoiceField(
        queryset=Department.objects.all(),
        required=False,
        empty_label="All Departments"
    )
    format = forms.ChoiceField(
        choices=[('html', 'Web View'), ('pdf', 'PDF'), ('excel', 'Excel')],
        initial='html',
        widget=forms.Select(attrs={'class': 'form-select'})
    )

class CustomUserCreationForm(UserCreationForm):
    email = forms.EmailField(required=True)
    role = forms.ChoiceField(choices=[
        ('admin', 'Administrator'),
        ('faculty', 'Faculty'),
        ('account', 'Account Department'),
        ('library', 'Library'),
    ], widget=forms.Select(attrs={'class': 'form-select'}))
    
    class Meta:
        model = User
        fields = ['username', 'email', 'first_name', 'last_name', 'role', 'password1', 'password2']
    
    def save(self, commit=True):
        user = super().save(commit=False)
        user.email = self.cleaned_data['email']
        if commit:
            user.save()
            # Here you would typically create a UserProfile with role
        return user
```

---

## **Part 3: Advanced Views**

### **views.py**
```python
# students/views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.urls import reverse_lazy
from django.views.generic import (
    ListView, DetailView, CreateView, UpdateView, DeleteView,
    TemplateView, FormView
)
from django.views.generic.detail import SingleObjectMixin
from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
from django.contrib.auth.decorators import login_required, permission_required
from django.contrib import messages
from django.db.models import Q, Count, Sum, Avg
from django.db import transaction
from django.http import HttpResponse, JsonResponse, HttpResponseRedirect
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.utils import timezone
from datetime import datetime, date, timedelta
import csv
import xlwt
from io import BytesIO
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import letter
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph
from reportlab.lib.styles import getSampleStyleSheet
from django.core.cache import cache
import json

from .models import (
    Student, Department, AcademicRecord,
    Attendance, FeePayment, Document, Notification
)
from .forms import (
    StudentForm, StudentSearchForm, AcademicRecordForm,
    AttendanceForm, FeePaymentForm, DocumentForm,
    BulkUploadForm, ReportFilterForm, DepartmentForm
)

# ==================== Dashboard Views ====================

class DashboardView(LoginRequiredMixin, TemplateView):
    """Main dashboard view"""
    template_name = 'students/dashboard.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        user = self.request.user
        
        # Statistics
        total_students = Student.objects.count()
        active_students = Student.objects.filter(is_active=True).count()
        departments = Department.objects.count()
        recent_students = Student.objects.order_by('-created_at')[:5]
        
        # Department-wise counts
        dept_stats = Department.objects.annotate(
            student_count=Count('student')
        ).order_by('-student_count')[:5]
        
        # Fee collection (current month)
        current_month = timezone.now().month
        current_year = timezone.now().year
        monthly_fees = FeePayment.objects.filter(
            payment_date__month=current_month,
            payment_date__year=current_year,
            is_verified=True
        ).aggregate(total=Sum('amount'))['total'] or 0
        
        # Attendance statistics
        today = date.today()
        today_attendance = Attendance.objects.filter(date=today).count()
        
        context.update({
            'total_students': total_students,
            'active_students': active_students,
            'departments': departments,
            'recent_students': recent_students,
            'dept_stats': dept_stats,
            'monthly_fees': monthly_fees,
            'today_attendance': today_attendance,
            'today': today,
        })
        
        return context

# ==================== Student CRUD Views ====================

class StudentListView(LoginRequiredMixin, ListView):
    """List all students with search and filter"""
    model = Student
    template_name = 'students/student_list.html'
    context_object_name = 'students'
    paginate_by = 25
    
    def get_queryset(self):
        queryset = Student.objects.select_related('department').all()
        
        # Apply filters from GET parameters
        search_by = self.request.GET.get('search_by', 'name')
        search_query = self.request.GET.get('search_query', '')
        department_id = self.request.GET.get('department')
        is_active = self.request.GET.get('is_active', '')
        enrollment_year = self.request.GET.get('enrollment_year')
        
        if search_query:
            if search_by == 'name':
                queryset = queryset.filter(
                    Q(first_name__icontains=search_query) |
                    Q(last_name__icontains=search_query)
                )
            elif search_by == 'student_id':
                queryset = queryset.filter(student_id__icontains=search_query)
            elif search_by == 'email':
                queryset = queryset.filter(email__icontains=search_query)
            elif search_by == 'roll_number':
                queryset = queryset.filter(roll_number__icontains=search_query)
            elif search_by == 'phone':
                queryset = queryset.filter(phone__icontains=search_query)
        
        if department_id:
            queryset = queryset.filter(department_id=department_id)
        
        if is_active == 'active':
            queryset = queryset.filter(is_active=True)
        elif is_active == 'inactive':
            queryset = queryset.filter(is_active=False)
        
        if enrollment_year:
            queryset = queryset.filter(enrollment_date__year=enrollment_year)
        
        # Ordering
        order_by = self.request.GET.get('order_by', '-enrollment_date')
        if order_by in [field.name for field in Student._meta.fields]:
            queryset = queryset.order_by(order_by)
        
        return queryset
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['search_form'] = StudentSearchForm(self.request.GET or None)
        context['departments'] = Department.objects.filter(is_active=True)
        context['total_count'] = self.get_queryset().count()
        
        # Add current filters to context
        context['current_filters'] = {
            'search_by': self.request.GET.get('search_by', ''),
            'search_query': self.request.GET.get('search_query', ''),
            'department': self.request.GET.get('department', ''),
            'is_active': self.request.GET.get('is_active', ''),
            'enrollment_year': self.request.GET.get('enrollment_year', ''),
            'order_by': self.request.GET.get('order_by', '-enrollment_date'),
        }
        
        return context

class StudentDetailView(LoginRequiredMixin, DetailView):
    """Detailed student view"""
    model = Student
    template_name = 'students/student_detail.html'
    context_object_name = 'student'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        student = self.object
        
        # Get related data
        context['academic_records'] = student.academic_records.all().order_by('-semester')
        context['fee_payments'] = student.fee_payments.all().order_by('-payment_date')
        context['attendances'] = student.attendances.all().order_by('-date')[:20]
        context['documents'] = student.documents.all().order_by('-upload_date')
        context['notifications'] = student.notifications.filter(is_read=False).order_by('-created_at')
        
        # Calculate statistics
        total_payments = student.fee_payments.filter(is_verified=True).aggregate(
            total=Sum('amount')
        )['total'] or 0
        
        # Attendance percentage for current month
        current_month = timezone.now().month
        month_attendance = student.attendances.filter(
            date__month=current_month
        ).count()
        month_present = student.attendances.filter(
            date__month=current_month,
            status='PRESENT'
        ).count()
        
        context['total_payments'] = total_payments
        context['month_attendance_percentage'] = (month_present / month_attendance * 100) if month_attendance > 0 else 0
        
        return context

class StudentCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """Create new student"""
    model = Student
    form_class = StudentForm
    template_name = 'students/student_form.html'
    permission_required = 'students.add_student'
    success_url = reverse_lazy('student_list')
    
    def form_valid(self, form):
        # Set created_by to current user
        form.instance.created_by = self.request.user
        form.instance.updated_by = self.request.user
        
        # Generate roll number
        department = form.cleaned_data['department']
        year = form.cleaned_data['enrollment_date'].year
        last_roll = Student.objects.filter(
            department=department,
            enrollment_date__year=year
        ).count()
        form.instance.roll_number = f"{department.code}{str(year)[-2:]}{last_roll + 1:03d}"
        
        messages.success(self.request, f'Student {form.instance.get_full_name()} created successfully!')
        return super().form_valid(form)
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = 'Add New Student'
        context['submit_text'] = 'Create Student'
        return context

class StudentUpdateView(LoginRequiredMixin, PermissionRequiredMixin, UpdateView):
    """Update student information"""
    model = Student
    form_class = StudentForm
    template_name = 'students/student_form.html'
    permission_required = 'students.change_student'
    
    def get_success_url(self):
        return reverse_lazy('student_detail', kwargs={'pk': self.object.pk})
    
    def form_valid(self, form):
        form.instance.updated_by = self.request.user
        messages.success(self.request, f'Student {form.instance.get_full_name()} updated successfully!')
        return super().form_valid(form)
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['title'] = f'Edit Student: {self.object.get_full_name()}'
        context['submit_text'] = 'Update Student'
        return context

class StudentDeleteView(LoginRequiredMixin, PermissionRequiredMixin, DeleteView):
    """Delete student"""
    model = Student
    template_name = 'students/confirm_delete.html'
    permission_required = 'students.delete_student'
    success_url = reverse_lazy('student_list')
    
    def delete(self, request, *args, **kwargs):
        student = self.get_object()
        student_name = student.get_full_name()
        response = super().delete(request, *args, **kwargs)
        messages.success(request, f'Student {student_name} deleted successfully!')
        return response
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['object_type'] = 'Student'
        return context

# ==================== Department Views ====================

class DepartmentListView(LoginRequiredMixin, ListView):
    """List all departments"""
    model = Department
    template_name = 'students/department_list.html'
    context_object_name = 'departments'
    
    def get_queryset(self):
        return Department.objects.annotate(
            student_count=Count('student')
        ).order_by('name')

class DepartmentCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """Create new department"""
    model = Department
    form_class = DepartmentForm
    template_name = 'students/department_form.html'
    permission_required = 'students.add_department'
    success_url = reverse_lazy('department_list')
    
    def form_valid(self, form):
        messages.success(self.request, f'Department {form.instance.name} created successfully!')
        return super().form_valid(form)

# ==================== Attendance Views ====================

@login_required
@permission_required('students.view_attendance', raise_exception=True)
def attendance_mark(request, student_id=None):
    """Mark attendance for single student or bulk"""
    student = None
    if student_id:
        student = get_object_or_404(Student, id=student_id)
    
    if request.method == 'POST':
        form = AttendanceForm(request.POST)
        if form.is_valid():
            attendance = form.save(commit=False)
            if student:
                attendance.student = student
            attendance.save()
            messages.success(request, 'Attendance marked successfully!')
            return redirect('attendance_list')
    else:
        initial = {'date': date.today()}
        if student:
            initial['student'] = student
        form = AttendanceForm(initial=initial)
    
    context = {
        'form': form,
        'student': student,
        'title': 'Mark Attendance'
    }
    return render(request, 'students/attendance_form.html', context)

class AttendanceListView(LoginRequiredMixin, ListView):
    """List attendance records"""
    model = Attendance
    template_name = 'students/attendance_list.html'
    context_object_name = 'attendances'
    paginate_by = 50
    
    def get_queryset(self):
        queryset = Attendance.objects.select_related('student').all()
        
        # Apply filters
        date_from = self.request.GET.get('date_from')
        date_to = self.request.GET.get('date_to')
        student_id = self.request.GET.get('student')
        status = self.request.GET.get('status')
        
        if date_from:
            queryset = queryset.filter(date__gte=date_from)
        if date_to:
            queryset = queryset.filter(date__lte=date_to)
        if student_id:
            queryset = queryset.filter(student_id=student_id)
        if status:
            queryset = queryset.filter(status=status)
        
        return queryset.order_by('-date', 'student__roll_number')
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['students'] = Student.objects.filter(is_active=True)
        return context

# ==================== Fee Payment Views ====================

class FeePaymentCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """Create fee payment"""
    model = FeePayment
    form_class = FeePaymentForm
    template_name = 'students/feepayment_form.html'
    permission_required = 'students.add_feepayment'
    
    def get_success_url(self):
        return reverse_lazy('student_detail', kwargs={'pk': self.object.student.pk})
    
    def form_valid(self, form):
        # Generate payment ID
        import uuid
        form.instance.payment_id = f"PAY-{uuid.uuid4().hex[:8].upper()}"
        
        # Generate receipt number
        last_receipt = FeePayment.objects.order_by('-id').first()
        if last_receipt:
            last_num = int(last_receipt.receipt_number.split('-')[-1])
            new_num = last_num + 1
        else:
            new_num = 1001
        form.instance.receipt_number = f"REC-{new_num:04d}"
        
        messages.success(self.request, f'Fee payment of ₹{form.instance.amount} recorded successfully!')
        return super().form_valid(form)
    
    def get_initial(self):
        initial = super().get_initial()
        student_id = self.request.GET.get('student_id')
        if student_id:
            try:
                student = Student.objects.get(id=student_id)
                initial['student'] = student
                initial['semester'] = student.current_semester
                initial['academic_year'] = f"{student.enrollment_date.year}-{student.enrollment_date.year + 1}"
            except Student.DoesNotExist:
                pass
        return initial

@login_required
@permission_required('students.change_feepayment', raise_exception=True)
def verify_payment(request, pk):
    """Verify a fee payment"""
    payment = get_object_or_404(FeePayment, pk=pk)
    
    if request.method == 'POST':
        payment.is_verified = True
        payment.verified_by = request.user
        payment.save()
        messages.success(request, f'Payment {payment.receipt_number} verified successfully!')
    
    return redirect('student_detail', pk=payment.student.pk)

# ==================== Document Views ====================

class DocumentUploadView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """Upload student document"""
    model = Document
    form_class = DocumentForm
    template_name = 'students/document_form.html'
    permission_required = 'students.add_document'
    
    def get_success_url(self):
        return reverse_lazy('student_detail', kwargs={'pk': self.object.student.pk})
    
    def form_valid(self, form):
        form.instance.uploaded_by = self.request.user
        messages.success(self.request, 'Document uploaded successfully!')
        return super().form_valid(form)
    
    def get_initial(self):
        initial = super().get_initial()
        student_id = self.request.GET.get('student_id')
        if student_id:
            try:
                initial['student'] = Student.objects.get(id=student_id)
            except Student.DoesNotExist:
                pass
        return initial

@login_required
@permission_required('students.delete_document', raise_exception=True)
def delete_document(request, pk):
    """Delete a document"""
    document = get_object_or_404(Document, pk=pk)
    student_id = document.student.pk
    
    if request.method == 'POST':
        document.delete()
        messages.success(request, 'Document deleted successfully!')
    
    return redirect('student_detail', pk=student_id)

# ==================== Bulk Operations ====================

@login_required
@permission_required('students.add_student', raise_exception=True)
def bulk_upload(request):
    """Handle bulk upload of students via CSV/Excel"""
    if request.method == 'POST':
        form = BulkUploadForm(request.POST, request.FILES)
        if form.is_valid():
            upload_type = form.cleaned_data['upload_type']
            file = request.FILES['file']
            
            try:
                if upload_type == 'students':
                    # Process student upload
                    success_count, error_count = process_student_csv(file, request.user)
                    messages.success(
                        request,
                        f'Bulk upload completed! Success: {success_count}, Errors: {error_count}'
                    )
                elif upload_type == 'attendance':
                    # Process attendance upload
                    success_count = process_attendance_csv(file, request.user)
                    messages.success(request, f'Attendance uploaded for {success_count} records!')
                
                return redirect('bulk_upload')
                
            except Exception as e:
                messages.error(request, f'Error processing file: {str(e)}')
    else:
        form = BulkUploadForm()
    
    return render(request, 'students/bulk_upload.html', {'form': form})

def process_student_csv(file, user):
    """Process CSV file for student bulk upload"""
    import csv
    from io import TextIOWrapper
    
    success_count = 0
    error_count = 0
    errors = []
    
    csv_file = TextIOWrapper(file.file, encoding='utf-8')
    reader = csv.DictReader(csv_file)
    
    for row_num, row in enumerate(reader, 1):
        try:
            with transaction.atomic():
                # Process each row
                student_data = {
                    'first_name': row.get('first_name', '').strip(),
                    'last_name': row.get('last_name', '').strip(),
                    'email': row.get('email', '').strip().lower(),
                    'phone': row.get('phone', '').strip(),
                    'date_of_birth': datetime.strptime(row['date_of_birth'], '%Y-%m-%d').date(),
                    'gender': row.get('gender', 'M').upper(),
                    'department': Department.objects.get(code=row['department_code']),
                    'enrollment_date': datetime.strptime(row['enrollment_date'], '%Y-%m-%d').date(),
                    'roll_number': row.get('roll_number', '').strip(),
                }
                
                # Create student
                student = Student(**student_data)
                student.created_by = user
                student.updated_by = user
                student.save()
                
                success_count += 1
                
        except Exception as e:
            error_count += 1
            errors.append(f"Row {row_num}: {str(e)}")
    
    # Store errors in session for display
    if errors:
        from django.contrib.sessions.backends.db import SessionStore
        session = SessionStore()
        session['bulk_upload_errors'] = errors[:10]  # Store first 10 errors
        session.save()
    
    return success_count, error_count

# ==================== Report Views ====================

@login_required
@permission_required('students.view_report', raise_exception=True)
def generate_report(request):
    """Generate various reports"""
    if request.method == 'POST':
        form = ReportFilterForm(request.POST)
        if form.is_valid():
            report_type = form.cleaned_data['report_type']
            start_date = form.cleaned_data['start_date']
            end_date = form.cleaned_data['end_date']
            department = form.cleaned_data['department']
            format_type = form.cleaned_data['format']
            
            # Generate report data
            if report_type == 'department_wise':
                data = generate_department_report(department, start_date, end_date)
                template = 'students/reports/department_report.html'
                filename = f'department_report_{date.today()}.'
            elif report_type == 'fee_collection':
                data = generate_fee_report(start_date, end_date, department)
                template = 'students/reports/fee_report.html'
                filename = f'fee_report_{date.today()}.'
            
            # Return in requested format
            if format_type == 'pdf':
                return generate_pdf_report(data, filename + 'pdf')
            elif format_type == 'excel':
                return generate_excel_report(data, filename + 'xls')
            else:
                # HTML format
                return render(request, template, {'data': data})
    else:
        form = ReportFilterForm()
    
    return render(request, 'students/report_generator.html', {'form': form})

def generate_department_report(department, start_date, end_date):
    """Generate department-wise student report"""
    queryset = Student.objects.select_related('department')
    
    if department:
        queryset = queryset.filter(department=department)
    
    if start_date:
        queryset = queryset.filter(enrollment_date__gte=start_date)
    if end_date:
        queryset = queryset.filter(enrollment_date__lte=end_date)
    
    # Aggregate data
    dept_data = queryset.values('department__name', 'department__code').annotate(
        total_students=Count('id'),
        active_students=Count('id', filter=Q(is_active=True)),
        avg_cgpa=Avg('cgpa'),
        avg_attendance=Avg('attendance_percentage')
    ).order_by('department__name')
    
    return {
        'report_type': 'Department Wise Report',
        'data': dept_data,
        'total_students': queryset.count(),
        'generated_on': timezone.now(),
        'filters': {
            'department': department.name if department else 'All',
            'start_date': start_date,
            'end_date': end_date
        }
    }

def generate_pdf_report(data, filename):
    """Generate PDF report"""
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'attachment; filename="{filename}"'
    
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=letter)
    
    # Create PDF content
    styles = getSampleStyleSheet()
    story = []
    
    # Add title
    title = Paragraph(data['report_type'], styles['Title'])
    story.append(title)
    
    # Add filters
    filters = f"Generated on: {data['generated_on']}<br/>"
    if data['filters']['department']:
        filters += f"Department: {data['filters']['department']}<br/>"
    if data['filters']['start_date']:
        filters += f"From: {data['filters']['start_date']}<br/>"
    if data['filters']['end_date']:
        filters += f"To: {data['filters']['end_date']}<br/>"
    
    story.append(Paragraph(filters, styles['Normal']))
    
    # Create table
    table_data = [['Department', 'Code', 'Total Students', 'Active Students', 'Avg CGPA', 'Avg Attendance']]
    
    for item in data['data']:
        row = [
            item['department__name'],
            item['department__code'],
            str(item['total_students']),
            str(item['active_students']),
            f"{item['avg_cgpa']:.2f}" if item['avg_cgpa'] else 'N/A',
            f"{item['avg_attendance']:.2f}%" if item['avg_attendance'] else 'N/A'
        ]
        table_data.append(row)
    
    # Add total row
    table_data.append(['TOTAL', '', str(data['total_students']), '', '', ''])
    
    table = Table(table_data)
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -2), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
    ]))
    
    story.append(table)
    doc.build(story)
    
    pdf = buffer.getvalue()
    buffer.close()
    response.write(pdf)
    
    return response

def generate_excel_report(data, filename):
    """Generate Excel report"""
    response = HttpResponse(content_type='application/ms-excel')
    response['Content-Disposition'] = f'attachment; filename="{filename}"'
    
    wb = xlwt.Workbook(encoding='utf-8')
    ws = wb.add_sheet('Report')
    
    # Write headers
    row_num = 0
    columns = ['Department', 'Code', 'Total Students', 'Active Students', 'Avg CGPA', 'Avg Attendance %']
    
    for col_num, column_title in enumerate(columns):
        ws.write(row_num, col_num, column_title)
    
    # Write data rows
    for item in data['data']:
        row_num += 1
        ws.write(row_num, 0, item['department__name'])
        ws.write(row_num, 1, item['department__code'])
        ws.write(row_num, 2, item['total_students'])
        ws.write(row_num, 3, item['active_students'])
        ws.write(row_num, 4, float(item['avg_cgpa']) if item['avg_cgpa'] else 0)
        ws.write(row_num, 5, float(item['avg_attendance']) if item['avg_attendance'] else 0)
    
    # Add total row
    row_num += 2
    ws.write(row_num, 2, data['total_students'])
    ws.write(row_num, 1, 'TOTAL')
    
    wb.save(response)
    return response

# ==================== API Views ====================

@login_required
def api_student_search(request):
    """API endpoint for student search (AJAX)"""
    query = request.GET.get('q', '')
    
    if query:
        students = Student.objects.filter(
            Q(first_name__icontains=query) |
            Q(last_name__icontains=query) |
            Q(student_id__icontains=query) |
            Q(email__icontains=query) |
            Q(roll_number__icontains=query)
        ).filter(is_active=True)[:10]
        
        data = [
            {
                'id': student.id,
                'name': student.get_full_name(),
                'student_id': student.student_id,
                'email': student.email,
                'department': student.department.name if student.department else '',
                'photo_url': student.photo.url if student.photo else '',
            }
            for student in students
        ]
    else:
        data = []
    
    return JsonResponse(data, safe=False)

@login_required
def api_dashboard_stats(request):
    """API endpoint for dashboard statistics"""
    cache_key = 'dashboard_stats'
    stats = cache.get(cache_key)
    
    if not stats:
        today = date.today()
        
        stats = {
            'total_students': Student.objects.count(),
            'active_students': Student.objects.filter(is_active=True).count(),
            'new_today': Student.objects.filter(created_at__date=today).count(),
            'total_departments': Department.objects.filter(is_active=True).count(),
            'today_attendance': Attendance.objects.filter(date=today, status='PRESENT').count(),
            'pending_payments': FeePayment.objects.filter(is_verified=False).count(),
            'monthly_collection': FeePayment.objects.filter(
                payment_date__month=today.month,
                payment_date__year=today.year,
                is_verified=True
            ).aggregate(total=Sum('amount'))['total'] or 0,
        }
        
        # Cache for 5 minutes
        cache.set(cache_key, stats, 300)
    
    return JsonResponse(stats)

@login_required
def api_student_chart(request):
    """API endpoint for student chart data"""
    # Department-wise student count
    dept_data = Department.objects.annotate(
        student_count=Count('student')
    ).values('name', 'student_count').order_by('-student_count')
    
    # Monthly student enrollment
    import calendar
    current_year = date.today().year
    monthly_data = []
    
    for month in range(1, 13):
        count = Student.objects.filter(
            enrollment_date__year=current_year,
            enrollment_date__month=month
        ).count()
        monthly_data.append({
            'month': calendar.month_abbr[month],
            'count': count
        })
    
    return JsonResponse({
        'department_data': list(dept_data),
        'monthly_data': monthly_data
    })

# ==================== Utility Views ====================

@login_required
def export_students(request):
    """Export students to CSV"""
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = 'attachment; filename="students_export.csv"'
    
    writer = csv.writer(response)
    
    # Write header
    writer.writerow([
        'Student ID', 'Name', 'Email', 'Phone', 'Department',
        'Enrollment Date', 'CGPA', 'Attendance %', 'Status'
    ])
    
    # Write data
    students = Student.objects.select_related('department').all()
    for student in students:
        writer.writerow([
            student.student_id,
            student.get_full_name(),
            student.email,
            student.phone,
            student.department.name if student.department else '',
            student.enrollment_date.strftime('%Y-%m-%d'),
            student.cgpa,
            student.attendance_percentage,
            'Active' if student.is_active else 'Inactive'
        ])
    
    return response

@login_required
def import_students(request):
    """Import students from CSV"""
    if request.method == 'POST' and request.FILES.get('csv_file'):
        csv_file = request.FILES['csv_file']
        
        # Process CSV file
        # ... (similar to bulk_upload but with different template)
        
        messages.success(request, 'Students imported successfully!')
        return redirect('student_list')
    
    return render(request, 'students/import_students.html')

@login_required
def send_notification(request, student_id):
    """Send notification to student"""
    student = get_object_or_404(Student, id=student_id)
    
    if request.method == 'POST':
        title = request.POST.get('title')
        message = request.POST.get('message')
        notification_type = request.POST.get('type', 'INFO')
        
        if title and message:
            Notification.objects.create(
                student=student,
                title=title,
                message=message,
                notification_type=notification_type,
                created_by=request.user
            )
            messages.success(request, 'Notification sent successfully!')
            return redirect('student_detail', pk=student_id)
    
    return render(request, 'students/send_notification.html', {'student': student})

# ==================== Custom Error Handlers ====================

def handler404(request, exception):
    """Custom 404 error handler"""
    return render(request, 'students/errors/404.html', status=404)

def handler500(request):
    """Custom 500 error handler"""
    return render(request, 'students/errors/500.html', status=500)

def handler403(request, exception):
    """Custom 403 error handler"""
    return render(request, 'students/errors/403.html', status=403)

def handler400(request, exception):
    """Custom 400 error handler"""
    return render(request, 'students/errors/400.html', status=400)

# ==================== Quick Actions ====================

@login_required
def quick_actions(request):
    """Handle quick actions from dashboard"""
    action = request.GET.get('action')
    
    if action == 'mark_attendance':
        return redirect('attendance_mark')
    elif action == 'add_student':
        return redirect('student_create')
    elif action == 'add_payment':
        return redirect('feepayment_create')
    elif action == 'generate_report':
        return redirect('generate_report')
    
    return redirect('dashboard')

@login_required
def toggle_student_status(request, student_id):
    """Toggle student active/inactive status"""
    student = get_object_or_404(Student, id=student_id)
    
    if request.method == 'POST':
        student.is_active = not student.is_active
        student.save()
        
        status = "activated" if student.is_active else "deactivated"
        messages.success(request, f'Student {student.get_full_name()} {status} successfully!')
    
    return redirect('student_detail', pk=student_id)
```

---
